<style>
    #tableArticle_wrapper .row,
    #tableImage_wrapper .row {
        margin: 0;
    }

    #tableArticle_wrapper .dt-row .col-sm-12,
    #tableImage_wrapper .dt-row .col-sm-12 {
        padding: 0;
        overflow-y: scroll;
        height: 600px;
    }
</style>
<div class="modal fade" id="autolinkModal" tabindex="-1" aria-labelledby="autolinkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-0">
            <div class="modal-header bg-light p-2">
                <h4 class="modal-title h5" id="autolinkModalLabel">Rechercher un article</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped" id="tableArticle">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th data-orderable="false">Choisir</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in articles %}
                            <tr>
                                <td>
                                    {{ item.title }}
                                </td>
                                <td class="text-end" style="width:10%">
                                    <button 
                                        class="btn btn-primary btn-sm close-btn-action" 
                                        data-slug="{{ item.slug }}"
                                        data-title="{{ item.title }}"
                                        title="choisir">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="galleryModal" tabindex="-1" aria-labelledby="galleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-0">
            <div class="modal-header bg-light p-2">
                <h4 class="modal-title h5" id="galleryModalLabel">Parcourir la galerie</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped" id="tableImage">
                    <thead>
                        <tr>
                            <th data-orderable="false">Image</th>
                            <th>Mots cl√©s</th>
                            <th data-orderable="false">Choisir</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for image in images %}
                            <tr>
                                <td style="width:10%" class="text-center align-middle">
                                    <a href="{{ vich_uploader_asset(image) }}" data-fslightbox>
                                        <img src="{{ vich_uploader_asset(image)|imagine_filter('icon_image') }}" alt="{{ image.title }}">
                                    </a>
                                </td>
                                <td class="small">
                                    <p class="mb-0 fw-bold">{{ image.title }}</p>
                                    <p class="mb-0">{{ image.keywords }}</p>
                                </td>
                                <td class="text-end" style="width:10%">
                                    <button 
                                        class="btn btn-primary btn-sm close-btn-image" 
                                        data-slug="{{ image.slug }}"
                                        data-filename="{{ image.filename }}"
                                        data-title="{{ image.title }}"
                                        title="choisir">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="{{ asset("assets/ckeditor/ckeditor.js") }}"></script>
<script>
    $('#tableArticle').DataTable({
        language: {
            url: '/assets/DataTables/i18n/fr-FR.json',
        },
        paging:false,
        info: false,
    });

    $('#tableImage').DataTable({
        language: {
            url: '/assets/DataTables/i18n/fr-FR.json',
        },
        paging:false,
        info: false,
        order: [[1, 'asc']]
    });

    const editor = CKEDITOR.replace( "{{target_id}}" );
    editor.config.allowedContent = true;
    editor.ui.addButton('autolinks',
        {
            label: "Ajouter le lien d'un article",
            command: 'autolinks_action', 
            toolbar: 'insert', 
            icon: '/assets/icons/articles.svg' 
        }
    );
    editor.ui.addButton('gallery',
        {
            label: "Parcourir la galerie",
            command: 'gallery_action', 
            toolbar: 'insert', 
            icon: '/assets/icons/gallery.svg' 
        }
    );

    const modal = new bootstrap.Modal(document.getElementById('autolinkModal'), {
        keyboard: false
    })
    const btns = document.querySelectorAll('.close-btn-action');
    btns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            modal.hide();
            const text = editor.getSelection().getSelectedText();
            let title = btn.dataset.title;
            if (text.length > 0) {
                title = text;
            }

            editor.insertHtml( `<a href="/articles/${btn.dataset.slug}">${title}</a>` ); 
        })
    });
    
    const imageBtns = document.querySelectorAll('.close-btn-image');
    imageBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            modalGalleryModal.hide();
            const path = `/uploads/${btn.dataset.filename}`;
            const title = btn.dataset.title;
            editor.insertHtml( `
                <a href="/images/${btn.dataset.slug}">
                    <img src="${path}" alt="${title}" title="${title}" style="max-width:100%">
                </a>` 
            ); 
        })
    });

    const modalGalleryModal = new bootstrap.Modal(document.getElementById('galleryModal'), {
        keyboard: false
    })

    editor.addCommand("autolinks_action", {
        exec: function (editor) {            
            modal.show();
        }
    });

    editor.addCommand("gallery_action", {
        exec: function (editor) {            
            modalGalleryModal.show();
        }
    });
</script>